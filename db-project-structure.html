<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2019-06-14 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20190614" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Obevo &#x2013; DB Project Structure</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                      <a href="https://github.com/goldmansachs/obevo">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="index.html" title="Intro">Intro</a></li>
            <li><a href="overview.html" title="Overview">Overview</a></li>
            <li><a href="setup.html" title="Setup">Setup</a></li>
            <li><a href="support.html" title="Help and Support">Help and Support</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Technical Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="db-project-structure.html" title="DB Project Structure">DB Project Structure</a></li>
            <li><a href="environment-management.html" title="Environment Management">Environment Management</a></li>
            <li><a href="permission-management.html" title="Permission Management">Permission Management</a></li>
            <li><a href="error-handling.html" title="Error-Handling">Error-Handling</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">API Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="command-line-api.html" title="Command-line API">Command-line API</a></li>
            <li><a href="java-api.html" title="Java API">Java API</a></li>
            <li><a href="maven-api.html" title="Maven plugin API">Maven plugin API</a></li>
            <li><a href="gradle-api.html" title="Gradle API">Gradle API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Advanced Topics <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="db-project-best-practices.html" title="DB Project Best Practices">DB Project Best Practices</a></li>
            <li><a href="rollback.html" title="Rollback">Rollback</a></li>
            <li><a href="multiple-schema-management.html" title="Multiple Schema Management">Multiple Schema Management</a></li>
            <li><a href="schema-and-config-packaging.html" title="Separate Schema and Config Packaging">Separate Schema and Config Packaging</a></li>
            <li><a href="in-memory-db-testing.html" title="In-memory DB Testing">In-memory DB Testing</a></li>
            <li><a href="parallel-deploy-execution.html" title="Parallel Deploy Execution">Parallel Deploy Execution</a></li>
            <li><a href="orm-integration.html" title="ORM Integration">ORM Integration</a></li>
            <li><a href="baseline-validation.html" title="Baseline DDL Validation">Baseline DDL Validation</a></li>
            <li><a href="phased-deployments.html" title="Phased Deployments">Phased Deployments</a></li>
            <li><a href="incremental-change-code-cleanup.html" title="Incremental Change Code Cleanup">Incremental Change Code Cleanup</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Platform-Specific Details <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="platform-listing.html" title="Platform Listing">Platform Listing</a></li>
            <li><a href="db2-notes.html" title="DB2">DB2</a></li>
            <li><a href="general-db-notes.html" title="HSQLDB">HSQLDB</a></li>
            <li><a href="general-db-notes.html" title="H2">H2</a></li>
            <li><a href="mongodb-notes.html" title="MongoDB">MongoDB</a></li>
            <li><a href="oracle-notes.html" title="Oracle">Oracle</a></li>
            <li><a href="postgresql-notes.html" title="PostgreSQL">PostgreSQL</a></li>
            <li><a href="redshift-notes.html" title="Redshift">Redshift</a></li>
            <li><a href="sybase-ase-notes.html" title="SQL Server">SQL Server</a></li>
            <li><a href="sybase-ase-notes.html" title="Sybase ASE">Sybase ASE</a></li>
            <li><a href="general-db-notes.html" title="Sybase IQ">Sybase IQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Onboarding Guide <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="onboarding-guide.html" title="Which onboarding to choose?">Which onboarding to choose?</a></li>
            <li><a href="new-onboarding-guide.html" title="New Systems">New Systems</a></li>
            <li><a href="existing-onboarding-guide.html" title="Existing Systems">Existing Systems</a></li>
            <li><a href="existing-diverging-onboarding-guide.html" title="Existing Systems with Diverging Shards">Existing Systems with Diverging Shards</a></li>
            <li><a href="legacy-onboarding-guide.html" title="Legacy Onboarding - Legacy Systems">Legacy Onboarding - Legacy Systems</a></li>
            <li><a href="db-merge-tool.html" title="DB Merge Tool">DB Merge Tool</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developer Information <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="developer-guide.html" title="Developer Guide">Developer Guide</a>
              <ul class="dropdown-menu">
                  <li><a href="dev-setup-docker.html" title="Docker-based Test DB Setup">Docker-based Test DB Setup</a></li>
                  <li><a href="dev-setup-amazon.html" title="Amazon RDS DB Setup">Amazon RDS DB Setup</a></li>
                  <li><a href="dev-setup-sybase-ase.html" title="Sybase ASE Test DB Setup">Sybase ASE Test DB Setup</a></li>
              </ul>
            </li>
            <li><a href="design-walkthrough.html" title="Design Walkthrough">Design Walkthrough</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="./" id="bannerLeft"><h2>Obevo</h2>
</a></div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li class=""><a href="./" title="Obevo">Obevo</a><span class="divider">/</span></li>
    <li class="active ">DB Project Structure</li>
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2019-06-14</li>
          <li id="projectVersion" class="pull-right">Version: master-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Getting Started</li>
    <li><a href="index.html" title="Intro"><span class="none"></span>Intro</a>  </li>
    <li><a href="overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="setup.html" title="Setup"><span class="none"></span>Setup</a>  </li>
    <li><a href="support.html" title="Help and Support"><span class="none"></span>Help and Support</a>  </li>
          <li class="nav-header">Technical Documentation</li>
    <li class="active"><a href="#"><span class="none"></span>DB Project Structure</a>
  </li>
    <li><a href="environment-management.html" title="Environment Management"><span class="none"></span>Environment Management</a>  </li>
    <li><a href="permission-management.html" title="Permission Management"><span class="none"></span>Permission Management</a>  </li>
    <li><a href="error-handling.html" title="Error-Handling"><span class="none"></span>Error-Handling</a>  </li>
          <li class="nav-header">API Documentation</li>
    <li><a href="command-line-api.html" title="Command-line API"><span class="none"></span>Command-line API</a>  </li>
    <li><a href="java-api.html" title="Java API"><span class="none"></span>Java API</a>  </li>
    <li><a href="maven-api.html" title="Maven plugin API"><span class="none"></span>Maven plugin API</a>  </li>
    <li><a href="gradle-api.html" title="Gradle API"><span class="none"></span>Gradle API</a>  </li>
          <li class="nav-header">Advanced Topics</li>
    <li><a href="db-project-best-practices.html" title="DB Project Best Practices"><span class="none"></span>DB Project Best Practices</a>  </li>
    <li><a href="rollback.html" title="Rollback"><span class="none"></span>Rollback</a>  </li>
    <li><a href="multiple-schema-management.html" title="Multiple Schema Management"><span class="none"></span>Multiple Schema Management</a>  </li>
    <li><a href="schema-and-config-packaging.html" title="Separate Schema and Config Packaging"><span class="none"></span>Separate Schema and Config Packaging</a>  </li>
    <li><a href="in-memory-db-testing.html" title="In-memory DB Testing"><span class="none"></span>In-memory DB Testing</a>  </li>
    <li><a href="parallel-deploy-execution.html" title="Parallel Deploy Execution"><span class="none"></span>Parallel Deploy Execution</a>  </li>
    <li><a href="orm-integration.html" title="ORM Integration"><span class="none"></span>ORM Integration</a>  </li>
    <li><a href="baseline-validation.html" title="Baseline DDL Validation"><span class="none"></span>Baseline DDL Validation</a>  </li>
    <li><a href="phased-deployments.html" title="Phased Deployments"><span class="none"></span>Phased Deployments</a>  </li>
    <li><a href="incremental-change-code-cleanup.html" title="Incremental Change Code Cleanup"><span class="none"></span>Incremental Change Code Cleanup</a>  </li>
          <li class="nav-header">Platform-Specific Details</li>
    <li><a href="platform-listing.html" title="Platform Listing"><span class="none"></span>Platform Listing</a>  </li>
    <li><a href="db2-notes.html" title="DB2"><span class="none"></span>DB2</a>  </li>
    <li><a href="general-db-notes.html" title="HSQLDB"><span class="none"></span>HSQLDB</a>  </li>
    <li><a href="general-db-notes.html" title="H2"><span class="none"></span>H2</a>  </li>
    <li><a href="mongodb-notes.html" title="MongoDB"><span class="none"></span>MongoDB</a>  </li>
    <li><a href="oracle-notes.html" title="Oracle"><span class="none"></span>Oracle</a>  </li>
    <li><a href="postgresql-notes.html" title="PostgreSQL"><span class="none"></span>PostgreSQL</a>  </li>
    <li><a href="redshift-notes.html" title="Redshift"><span class="none"></span>Redshift</a>  </li>
    <li><a href="sybase-ase-notes.html" title="SQL Server"><span class="none"></span>SQL Server</a>  </li>
    <li><a href="sybase-ase-notes.html" title="Sybase ASE"><span class="none"></span>Sybase ASE</a>  </li>
    <li><a href="general-db-notes.html" title="Sybase IQ"><span class="none"></span>Sybase IQ</a>  </li>
          <li class="nav-header">Onboarding Guide</li>
    <li><a href="onboarding-guide.html" title="Which onboarding to choose?"><span class="none"></span>Which onboarding to choose?</a>  </li>
    <li><a href="new-onboarding-guide.html" title="New Systems"><span class="none"></span>New Systems</a>  </li>
    <li><a href="existing-onboarding-guide.html" title="Existing Systems"><span class="none"></span>Existing Systems</a>  </li>
    <li><a href="existing-diverging-onboarding-guide.html" title="Existing Systems with Diverging Shards"><span class="none"></span>Existing Systems with Diverging Shards</a>  </li>
    <li><a href="legacy-onboarding-guide.html" title="Legacy Onboarding - Legacy Systems"><span class="none"></span>Legacy Onboarding - Legacy Systems</a>  </li>
    <li><a href="db-merge-tool.html" title="DB Merge Tool"><span class="none"></span>DB Merge Tool</a>  </li>
          <li class="nav-header">Developer Information</li>
    <li><a href="developer-guide.html" title="Developer Guide"><span class="icon-chevron-down"></span>Developer Guide</a>
      <ul class="nav nav-list">
    <li><a href="dev-setup-docker.html" title="Docker-based Test DB Setup"><span class="none"></span>Docker-based Test DB Setup</a>  </li>
    <li><a href="dev-setup-amazon.html" title="Amazon RDS DB Setup"><span class="none"></span>Amazon RDS DB Setup</a>  </li>
    <li><a href="dev-setup-sybase-ase.html" title="Sybase ASE Test DB Setup"><span class="none"></span>Sybase ASE Test DB Setup</a>  </li>
      </ul>
  </li>
    <li><a href="design-walkthrough.html" title="Design Walkthrough"><span class="none"></span>Design Walkthrough</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--

    Copyright 2017 Goldman Sachs.
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

--><h1>DB Project Structure</h1>
<p>Obevo allows users to maintain their database scripts in an object-based structure, such as the structure below. This page describes how to implement this.</p>
<p><img src="images/db-kata-file-setup.jpg" alt="DB Project Structure" /></p>

<ul>
<li><a href="#system-config.xml">system-config.xml</a></li>
<li><a href="#Schema_folders">Schema folders</a></li>
<li><a href="#Separating_Schema_Packaging_from_Config">Separating Schema Packaging from Config</a></li>
<li><a href="#File_Structure_for_all_object_types">File Structure (for all object types)</a></li>
<li><a href="#Defining_Table_Changes">Defining Table Changes</a></li>
<li><a href="#Defining_Rerunnable_Object_Changes_Stored_Procedures_Views_Functions_">Defining Rerunnable Object Changes (Stored Procedures, Views, Functions, &#x2026;)</a></li>
<li><a href="#DB_Object_Deployment_Order">DB Object Deployment Order</a></li>
<li><a href="#Managing_Static_Data__Code_Tables">Managing Static Data / Code Tables</a></li>
<li><a href="#Ad-hoc_data_migrations">Ad-hoc data migrations</a></li></ul>
<div class="section">
<h2><a name="system-config.xml"></a>system-config.xml</h2>
<div class="section">
<h3><a name="Base_Structure"></a>Base Structure</h3>
<p>The system-config.xml file is the starting point of your db source code. Hence, the directory containing it is your db root folder</p>

<ul>
  
<li>It is located under src/main/database to abide by Maven conventions; however, this is not mandatory</li>
</ul>
<p>system-config.xml defines:</p>

<ul>
  
<li>The <i><u>logical schemas</u></i> that this unit of code would maintain (in this example, we only maintain 1 logical schema DEMOSCHEMA)
  
<ul>
    
<li>By logical schema - we refer to the schema that we would ideally see in a particular production environment</li>
    
<li>Compare this to the <i><u>physical schema</u></i>, which may have a suffix appended depending on the environment
    
<ul>
      
<li>e.g. in prod, we have DEMOSCHEMA</li>
      
<li>in uat, we have DEMO_SCHEMA_UAT1</li>
      
<li>in dev, we have DEMO_SCHEMA_DEV1</li>
      
<li>and so on</li>
    </ul></li>
    
<li>The logical schema name should only contain alphanumeric characters and underscores</li>
    
<li><font color="red">NOTE for Sybase ASE and SQL Server users: The &#x201c;schema&#x201d; term in Obevo is equivalent to the Sybase ASE &#x201c;database&#x201d;</font>. By default, we assume the default user during SQL execution. See the section below on how to use the database + schema.</li>
  </ul></li>
  
<li>The <i><u>db environments</u></i> that we plan on deploying to
  
<ul>
    
<li>e.g. dev1 environments deploys to myserver1.dev.me.com:1234, prod deploys to myserver1.prod.me.com:1234</li>
  </ul></li>
</ul>
<p>You can read the provided <a class="externalLink" href="https://github.com/goldmansachs/obevo-kata/tree/master/src/main/database/system-config.xml">system-config.xml file</a> for some of the features and configurations that you can define</p>
<p>A couple of the key configs to note (see the xml example for details):</p></div>
<div class="section">
<h3><a name="Defining_your_DB_Connection"></a>Defining your DB Connection</h3>
<p>You can define your DB connection in 3 different ways:</p>

<ul>
  
<li>via the jdbcUrl attribute, where you simply provide the JDBC url; e.g. db2://myhost1.me.com:1234/MYSERVER</li>
  
<li>via the dbHost, dbSchema, and dbServer attributes, where you provide those and the underlying JDBC url is constructed for you; e.g. dbHost=&#x201c;myhost1.me.com&#x201d; dbPort=&#x201c;1234&#x201d; dbServer=&#x201c;MYSERVER1&#x201d;</li>
  
<li>via the dbDataSourceName, where you provide the LDAP name and the tool will look up the source in LDAP; e.g. dbDataSourceName=MYSERVER1</li>
</ul></div>
<div class="section">
<h3><a name="Schema_Suffix_or_Prefix_Convention"></a>Schema Suffix or Prefix Convention</h3>
<p>The dbSchemaPrefix and/or dbSchemaSuffix attributes can be used to add a prefix or suffix across your logical schemas when pointing to a particular environment</p>

<ul>
  
<li>This is to help enforce the convention of having a consistent schema naming convention across environments
  
<ul>
    
<li>e.g. &lt;SCHEMA_NAME&gt;&lt;ENVIRONMENT_SUFFIX&gt;</li>
    
<li>From anecdotal evidence, most teams go w/ the suffix convention, but a few go w/ prefixes, e.g. &lt;ENVIRONMENT_PREFIX&gt;&lt;SCHEMA_NAME&gt;</li>
  </ul></li>
  
<li>In case your system already has the schemas defined and need to define the schema names outside of this convention, you can use the &lt;schemaOverrides&gt; element.
  
<ul>
    
<li>Note that the overrideValue will override even the environment suffix/prefix convention if you have specified it</li>
    
<li>See the example below:</li>
    
<li>For SQL Server and Sybase ASE, this value applies to the database used for your objects. See the next section for schema handling</li>
  </ul></li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">&lt;!--schema override example --&gt;
&lt;dbSystemConfig type=&quot;DB2&quot;&gt;
    &lt;schemas&gt;
        &lt;schema name=&quot;SCHEMA1&quot; /&gt;
        &lt;schema name=&quot;SCHEMA2&quot; /&gt;
        &lt;schema name=&quot;SCHEMA3&quot; /&gt;
    &lt;/schemas&gt;
    &lt;environments&gt;
        &lt;dbEnvironment name=&quot;test&quot; dbServer=&quot;example&quot; ...&gt;
            &lt;schemaOverrides&gt;
                &lt;schemaOverride schema=&quot;SCHEMA1&quot; overrideValue=&quot;my_schema1abc&quot; /&gt;
                &lt;schemaOverride schema=&quot;SCHEMA2&quot; overrideValue=&quot;my_schema2def&quot; /&gt;
                &lt;!-- you don't have to specify an override if you don't want to, say for SCHEMA3 in this example. Then, it will just take the original value --&gt;
            &lt;/schemaOverrides&gt;
            ...
        &lt;/dbEnvironment&gt;
    &lt;/environments&gt;
&lt;/dbSystemConfig&gt;
</pre></div></div></div>
<div class="section">
<h3><a name="aFor_SQL_Server_and_Sybase_ASE_database.schema_convention"></a>[For SQL Server and Sybase ASE] database.schema convention</h3>
<p>By default, Obevo will refer to an object by its default catalog/database. For example:</p>

<ul>
  
<li>In DB2: schema1.object1</li>
  
<li>In SQL Server: schema1..object1 (note the extra period)</li>
</ul>
<p>We imply the schema user here (e.g. dbo - schema1.dbo.object1)</p>
<p>If you need to define your objects in a schema within the database, consider the following:</p>

<ul>
  
<li>If you want to manage multiple schemas within your database, you will need to map each database+schema combination to a logical schema</li>
  
<li>Use the schemaOverride element to define the database/schema combination, e.g.</li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">&lt;!--schema override example --&gt;
&lt;dbSystemConfig type=&quot;SYBASE_ASE&quot;&gt;
    &lt;schemas&gt;
        &lt;schema name=&quot;SCHEMA1&quot; /&gt;
        &lt;schema name=&quot;SCHEMA2&quot; /&gt;
    &lt;/schemas&gt;
    &lt;environments&gt;
    &lt;dbEnvironment name=&quot;test&quot; ...&gt;
        &lt;schemaOverrides&gt;
            &lt;!-- note - many logical schemas can map to different schemas within the same database --&gt;
            &lt;schemaOverride schema=&quot;SCHEMA1&quot; overrideValue=&quot;mydatabase.myschema1&quot; /&gt;
            &lt;schemaOverride schema=&quot;SCHEMA2&quot; overrideValue=&quot;mydatabase.myschema2&quot; /&gt;
        &lt;/schemaOverrides&gt;
        ...
    &lt;/dbEnvironment&gt;
    &lt;/environments&gt;
&lt;/dbSystemConfig&gt;
</pre></div></div>

<ul>
  
<li>In your DB object code, if you need to refer to the schema, then you can use the tokens &lt;logicalSchema&gt;_schemaSuffixed and &lt;logicalSchema&gt;_subschemaSuffixed to give you either the &#x201c;mydatabase.myschema1.&#x201d; token value or &#x201c;myschema1.&#x201d; token value, respectively</li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">CREATE TABLE ${SCHEMA1_subschemaSuffixed}myobject ( ... )
</pre></div></div></div>
<div class="section">
<h3><a name="Advanced_Environment_Management"></a>Advanced Environment Management</h3>
<p>You can do more advanced environment management with Obevo, including tokenization, permission management, and environment-specific deployments.</p>
<p>See the <a href="environment-management.html">Environment Management page</a> for more information, though you should first understand the rest of this page and the DB project structure basics.</p></div></div>
<div class="section">
<h2><a name="Schema_folders"></a>Schema folders</h2>
<p>Underneath your root folder, you should define a folder for each of the logical schemas that you will maintain in this module.</p>
<p>For each schema, you will then define the table, sp, view, data, &#x2026; folders</p></div>
<div class="section">
<h2><a name="Separating_Schema_Packaging_from_Config"></a>Separating Schema Packaging from Config</h2>
<p>In some use cases, you may want to separate the directories in which your config and your schema folders reside.</p>
<p>It is worth going through the rest of this page first to understand the basics. But if you do want to explore separating your config and schemas, please see the <a href="schema-and-config-packaging.html">schema-and-config-packaging</a> page for more details.</p></div>
<div class="section">
<h2><a name="File_Structure_for_all_object_types"></a>File Structure (for all object types)</h2>
<div class="section">
<h3><a name="Structure"></a>Structure</h3>
<p>Your table definitions will go under the table folder in the schemas</p>
<p>As mentioned in the intro doc, the goal here is to promote a db-object-oriented structure for your code base. Hence:</p>

<ul>
  
<li>Particular object types are rooted under folders of that name (e.g. tables go in /table, stored procedures under /sp, /view, /function, /data, /sequence, and so on)</li>
  
<li>Changes for a particular db object will go into a file named of that object, e.g.</li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">table/PRODUCT.sql
table/ACCOUNT.ddl
table/ENTITY.sql
table/codes/NET_TYPE.sql
table/codes/INSTRUMENT.ddl
table/codes/PROD_TYPE.fx.abc.sql
table/codes/PROD_TYPE.fi.abc.sql
view/V_PRODUCT.sql
view/V_ENTITY.sql
sp/CREATE_PRODUCT.ddl
data/codes/INSTRUMENT.sql
data/NET_TYPE.csv
</pre></div></div></div>
<div class="section">
<h3><a name="Naming_rules__flexibilities"></a>Naming rules / flexibilities</h3>
<p>The only rules to consider here are:</p>

<ol style="list-style-type: decimal">
  
<li>The DB object name should be the first segment of the file name (i.e. before the first dot)
  
<ol style="list-style-type: decimal">
    
<li>e.g. PRODUCT.sql would correspond to a table named PRODUCT</li>
    
<li>e.g. ACCOUNT.sql would correspond to a table named ACCOUNT</li>
    
<li>e.g. PROD_TYPE.fx.abc.sql would correspond to a table named PROD_TYPE (i.e. the intermediate .fx.abc. does not matter</li>
  </ol></li>
  
<li>The DB object names must be unique for a particular environment (e.g. multiple files for DB objects named PRODUCT cannot be defined for a particular environment)
  
<ol style="list-style-type: decimal">
    
<li>In a later section, we will show how to have environment-specific inclusions/exclusions of objects, which would allow the structure involving PROD_TYPE.fi.abc.sql and PROD_TYPE.fx.abc.sql above (not that we encourage doing this a lot)</li>
  </ol></li>
</ol>
<p>In terms of what you are flexible with:</p>

<ul>
  
<li>You can define your table files anywhere under /table, i.e. you can put them in subdirectories</li>
  
<li>The extension does not matter - can be ddl, sql, txt, whatever</li>
</ul>
<p>This applies for all object types</p></div>
<div class="section">
<h3><a name="Common_content_conventions"></a>Common content conventions</h3>
<p>You can use the \${token} convention to replace tokens that you&#x2019;ve defined in system-config.xml</p>
<p>Now we discuss the specific content rules for each of the object types</p>
<p>Stored procedures, views, and data are very easy to define in Obevo; but given that tables are focal point of databases, we will start there</p></div></div>
<div class="section">
<h2><a name="Defining_Table_Changes"></a>Defining Table Changes</h2>
<p>Below is an example of a table file. We will describe below:</p>

<div class="source">
<div class="source"><pre class="prettyprint">//// CHANGE name=chng1
CREATE TABLE TABLE_A (
    A_ID    INT NOT NULL,
    B_ID    INT NOT NULL,
    STRING_FIELD    VARCHAR(30) NULL,
    TIMESTAMP_FIELD TIMESTAMP   NULL,
    PRIMARY KEY (A_ID)
)
GO
//// CHANGE name=chng3
ALTER TABLE TABLE_A ADD COLUMN C_ID INT NULL
GO
//// CHANGE name=chng2
ALTER TABLE TABLE_A ADD FOREIGN KEY FK_B (B_ID) REFERENCES TABLE_B(B_ID)
GO
//// CHANGE name=mytrigger
CREATE TRIGGER mytrigger ON TABLE_A
FOR abc123 ...
GO
//// CHANGE name=extra1
ALTER TABLE TABLE_A ADD COLUMN EXTRA1 INT NULL
GO
</pre></div></div>
<p>Basically, all alters on a table (including CREATE TABLE, ALTER TABLE, adding constraints, adding indexes, adding FKs or triggers) will go into this file</p>
<p>Each change for a particular release or functionality should be demarcated using the &#x201c;//// CHANGE name=123&#x201d; annotation</p>

<ul>
  
<li>The name must be distinct <i>within</i> the file. The same name could exist in different files</li>
  
<li>A convention that teams have used for the name is to use the JIRA ticket number of the issue orcommit</li>
</ul>
<p>If you use the global permissions functionality, you do not need to define GRANT statements in your files! The tool will automatically execute these for you upon detecting a &#x201c;CREATE TABLE&#x201d; phrase (whitespace between CREATE and TABLE is taken care of)</p>
<div class="section">
<h3><a name="Immutable__CHANGE_sections"></a>Immutable //// CHANGE sections</h3>
<p>Once a change is deployed to an environment, <b><i><u>it cannot be modified or deleted</u></i></b>.</p>

<ul>
  
<li>You must create a new alter statement. This is required to guarantee that we can always replay all the changes in a DB file to recreate the schema from scratch</li>
  
<li>Modifying white-space is fine; the tool will tolerate that. But changing actual content will fail.</li>
  
<li>Fyi, the tool does this by taking a MD5 hash of the change content and storing it in the audit table</li>
</ul>
<p>(*) - For special cases (e.g. undoing a change deployed to UAT but not prod), a //// CHANGE can be removed with a special directive in the code. See the <a href="rollback.html">Rollback</a> page for details.</p></div>
<div class="section">
<h3><a name="Dropping_tables_and_removing_table_files"></a>Dropping tables and removing table files</h3>
<p>Given that changes are immutable, can I drop a table and then remove a file? Yes, but with special directives. We do not want to just delete a file and have the table dropped, as we can&#x2019;t foresee any cases of accidentally dropping or renaming a file; we want to be conservative in this case</p>
<p>Steps for dropping a table:</p>

<ol style="list-style-type: decimal">
  
<li>Add a new change w/ the DROP_TABLE toggle, per the following example. Note that no SQL needs to be provided; in the future, we will allow users to enter their own SQL in that section to execute.</li>
</ol>

<div class="source">
<div class="source"><pre class="prettyprint">//// CHANGE name=chng1
CREATE TABLE TABLE_DROP (
    ID INT NOT NULL,
    PRIMARY KEY (ID)
)
GO

//// CHANGE name=drop DROP_TABLE
</pre></div></div>

<ol style="list-style-type: decimal">
  
<li>Deploy this change across all environments to drop the table. This will also clear the DeployLog table of this object.</li>
  
<li>You are then free to delete the file from your source code. Note that if you were to deploy your source code to a brand new DB, then this file will not get deployed (the existence of the DROP_TABLE command will preclude it).</li>
</ol></div>
<div class="section">
<h3><a name="Renaming_tables"></a>Renaming tables</h3>
<p>You have a couple options on renaming tables in Obevo</p>
<div class="section">
<h4><a name="Option_1:_Create_the_new_table_and_migrate_the_data_over"></a>Option 1: Create the new table and migrate the data over</h4>
<p>The migration SQL should be in a /migration change (described in the sections below), so that the object files remain clean</p>
<p>The changes will also need the dependencies attributes to ensure ordering of the files (see the subsequent sections for more information on migrations and dependencies)</p>
<p>### /table/OrigTable.sql</p>

<div class="source">
<div class="source"><pre class="prettyprint">//// CHANGE name=&quot;init&quot;
CREATE TABLE OrigTable (
    Field1 int,
    Field2 int
)
GO
//// CHANGE name=&quot;dropOld&quot; DROP_TABLE dependencies=&quot;OldToNewTableMigration.migration&quot;
</pre></div></div>
<p>### /table/NewTable.sql</p>

<div class="source">
<div class="source"><pre class="prettyprint">//// CHANGE name=&quot;init&quot;
CREATE TABLE NewTable (
    NewField1 int,
    NewField2 int
)
</pre></div></div>
<p>### /migration/OldToNewTableMigration.sql</p>

<div class="source">
<div class="source"><pre class="prettyprint">//// CHANGE name=&quot;migration&quot; includeDependencies=&quot;OrigTable.init,NewTable.init&quot;
INSERT INTO NewTable (NewField1, NewField2)
SELECT Field1, Field2 FROM OrigTable
GO
</pre></div></div></div>
<div class="section">
<h4><a name="Option_2:_Use_the_rename_command_provided_by_the_DBMS"></a>Option 2: Use the rename command provided by the DBMS</h4>
<p>As of this version, doing this in Obevo is a bit clunky, as you won&#x2019;t be able to delete the old file, and the new file would not have the DDL defined. Suggestions to work around this for now:</p>

<ul>
  
<li>If you need this for in-memory testing, use the workarounds for manually defining a translation SQL defined <a href="in-memory-db-testing">here</a></li>
  
<li>If you want to redefine the new file to define the change SQL in a cleaner way, see the <a href="incremental-change-code-cleanup.html">re-baselining documentation</a>.</li>
</ul>
<p>### /table/OrigTable.sql</p>

<div class="source">
<div class="source"><pre class="prettyprint">//// CHANGE name=&quot;init&quot;
CREATE TABLE OrigTable (
    Field1 int,
    Field2 int
)
GO
//// CHANGE name=&quot;dropOld&quot; DROP_TABLE dependencies=&quot;OldToNewTableMigration.migration&quot;
</pre></div></div>
<p>### /table/NewTable.sql</p>

<div class="source">
<div class="source"><pre class="prettyprint">//// CHANGE name=&quot;init&quot; dependencies=&quot;OrigTable.init&quot;
sp_rename 'OrigTable', 'NewTable'
-- Note - sp_rename is specific for Sybase. May be different for other DBMS types; this is just an example.
</pre></div></div></div></div></div>
<div class="section">
<h2><a name="Defining_Rerunnable_Object_Changes_Stored_Procedures_Views_Functions_"></a>Defining Rerunnable Object Changes (Stored Procedures, Views, Functions, &#x2026;)</h2>
<p>This spans the following object types (and this would be the directory structure you&#x2019;d apply for each)</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th>Object Type</th>
      
<th>Directory</th>
      
<th>Vendor-specific Note</th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td>Stored Procedures</td>
      
<td colspan="2">/sp</td>
    </tr>
    
<tr class="a">
      
<td>Views</td>
      
<td colspan="2">/view</td>
    </tr>
    
<tr class="b">
      
<td>Functions</td>
      
<td colspan="2">/function</td>
    </tr>
    
<tr class="a">
      
<td>Sequences</td>
      
<td colspan="2">/sequence</td>
    </tr>
    
<tr class="b">
      
<td>Triggers</td>
      
<td colspan="2">/trigger</td>
    </tr>
    
<tr class="a">
      
<td>User Types</td>
      
<td>/usertype</td>
      
<td>Only Sybase ASE and MS SQL Server</td>
    </tr>
    
<tr class="b">
      
<td>Rule</td>
      
<td>/rule</td>
      
<td>Only Sybase ASE and MS SQL Server</td>
    </tr>
    
<tr class="a">
      
<td>Default</td>
      
<td>/default</td>
      
<td>Only Sybase ASE and MS SQL Server</td>
    </tr>
    
<tr class="b">
      
<td>Packages + Package Bodies</td>
      
<td>/routinepackage</td>
      
<td>Only for Oracle</td>
    </tr>
    
<tr class="a">
      
<td>Synonyms</td>
      
<td>/synonym</td>
      
<td>Currently only for Oracle; other vendors will be supported later</td>
    </tr>
  </tbody>
</table>
<p>Here is an example:</p>

<div class="source">
<div class="source"><pre class="prettyprint">CREATE PROCEDURE SP1 ()
LANGUAGE SQL DYNAMIC RESULT SETS 1
BEGIN ATOMIC
    CALL SP2(2);
    CALL SP2(3);
END
GO
</pre></div></div>
<p>That&#x2019;s it! Just a matter of creating, editing, and deleting the file; just like Java. i.e.</p>

<ul>
  
<li>To create the SP/view/&#x2026;, create the file w/ the create statement content (along w/ adding the grants if you&#x2019;ve defined the global permissions)</li>
  
<li>To edit the SP/view/&#x2026;, edit the file. Obevo will do the drop/add for you (along w/ re-adding the grants if you&#x2019;ve defined the global permissions)</li>
  
<li>To drop the SP/view/&#x2026;, delete the file. Obevo will do the drop for you</li>
</ul>
<div class="section">
<h3><a name="Best_practices_for_rerunnable_objects"></a>Best practices for rerunnable objects</h3>
<p>Use &#x201c;CREATE OR REPLACE&#x201d; to create the object if your DBMS supports it, so that dependent objects do not have to be recreated as is needed for some DBs.</p>
<p>Likewise, if there are other syntax features of your DBMS (besides CREATE OR REPLACE) that you can use to create objects without recreating dependents, please do so. (See <a href="redshift-notes.html">Redshift doc page</a> for an example of this.</p>
<p>Do not define the &#x201c;DROP PROCEDURE/VIEW/&#x2026;&#x201d; statement in your file. Obevo does it for you.</p></div>
<div class="section">
<h3><a name="Side_use-case_for_SPs_with_function_overloads"></a>Side use-case for SPs with function overloads</h3>
<p>For cases where you have SPs of the same name, but different argument lengths, those should be defined in the same file</p>
<p>Obevo will take care of dropping each of the instances as needed</p></div>
<div class="section">
<h3><a name="Objects_with_BODY_components_e.g._Oracle_packages"></a>Objects with BODY components, e.g. Oracle packages</h3>
<p>Some database objects, such as <a class="externalLink" href="https://docs.oracle.com/cd/B19306_01/appdev.102/b14261/packages.htm">Oracle packages</a>, are defined across two SQL statements: a declaration of the object signature, and its implementation.</p>
<p>The implementation can be more complex, esp. with referring to other objects, and so we would not want to force the two to be deployed in sequence.</p>
<p>Hence, we allow the file content to be split in two using the &#x201c;//// BODY&#x201d; line; the content preceding that line is the signature, and afterward the implementation body. See below for an example:</p>

<div class="source">
<div class="source"><pre class="prettyprint">CREATE OR REPLACE PACKAGE MY_EXAMPLE_PACKAGE
AS
    FUNCTION MY_FUNC1 return integer;
    FUNCTION MY_FUNC2(var1 IN integer) return integer;
END;
GO

//// BODY
CREATE OR REPLACE PACKAGE BODY MY_EXAMPLE_PACKAGE
AS
    FUNCTION MY_FUNC1
    RETURN integer IS
    BEGIN
        RETURN 1;
    END;

    FUNCTION MY_FUNC2 (var1 IN integer)
    RETURN integer IS
    BEGIN
        RETURN 1;
    END;
END;
GO
</pre></div></div></div></div>
<div class="section">
<h2><a name="DB_Object_Deployment_Order"></a>DB Object Deployment Order</h2>
<p>A key tenet of Obevo is to not require excessive overhead on developers to define the order of db changes for <b><u>every single change</u></b> , e.g. via a sequence file or a versioning convention. It tries to be similar to application languages, e.g. Java, where users do not worry about the compilation order of classes within a module.</p>
<p>Obevo takes care of this by:</p>

<ol style="list-style-type: decimal">
  
<li>Inferring dependency order across objects by inspecting the text</li>
  
<li>Allowing users to explicitly define a dependency order if needed to override the default behavior</li>
</ol>
<p>See the <a href="design-walkthrough.html#Sorting_Changes_in_the_file-per-object_format">Design Walkthrough</a> for more details on how this is done.</p>
<p>Specific steps on applying this to your code:</p>
<div class="section">
<h3><a name="Automatic_Inference_of_Order_Based_on_the_Code"></a>Automatic Inference of Order Based on the Code</h3>
<p>Order across all object types is inferred automatically based on the code of the object or CHANGE, except:</p>

<ul>
  
<li>staticdata: The dependencies are inferred based on the foreign key relations defined in the associated table change</li>
  
<li>migration: No automatic inference is done. Users will have to define dependencies explicitly</li>
</ul>
<p>Note: cross-schema object dependencies cannot yet be inferred. Please use the explicit dependency specification for those use cases, described next.</p></div>
<div class="section">
<h3><a name="Explicit_dependency_definition_by_users_to_overridesupplement_the_inferred_dependency"></a>Explicit dependency definition by users to override/supplement the inferred dependency</h3>
<p>To define the dependency explicitly, add the &#x201c;dependencies&#x201d;, &#x201c;includeDependencies&#x201d;, or &#x201c;excludeDependencies&#x201d; value to either the //// CHANGE line (for incremental changes) or //// METADATA line (for rerunnable objects)</p>
<p>The value is a comma-separated string that points to the dependencies of that change:</p>

<ul>
  
<li>dependencies: overrides the value inferred by Obevo entirely w/ what the user provides</li>
  
<li>includeDependencies: adds the given dependencies to the value inferred by Obevo</li>
  
<li>excludeDependencies: removes the given dependencies from the value inferred by Obevo</li>
</ul>
<p>When to use each:</p>

<ul>
  
<li>excludeDependencies is the most common use case, as you will usually have to exclude the false positives from the dependency detection (e.g. from comments and strings)</li>
  
<li>includeDependencies is for rarer cases, say if you need to include a cross-schema object dependency</li>
  
<li>dependencies is useful for &#x201c;migration&#x201d; change types (see below) that really require explicit dependency ordering</li>
</ul>
<p>String format for each dependency is one of the following:</p>

<ul>
  
<li>[objectName]</li>
  
<li>[objectName].[changeName]</li>
  
<li>[logicalSchemaName].[objectName]</li>
  
<li>[logicalSchemaName].[objectName].[changeName]</li>
</ul>
<p>(Reminder: use the logicalSchemaName here - not the physical schema name)</p>
<p>Examples:</p>

<ul>
  
<li>//// METADATA dependencies=&#x201c;sp1,sp2&#x201d; =&gt;would force the dependencies of the object to be sp1,sp2</li>
  
<li>//// METADATA excludeDependencies=&#x201c;schema1.sp3&#x201d; =&gt; would exclude schema1.sp3 from the automatic dependency calculation</li>
  
<li>//// CHANGE name=&#x201c;chng1&#x201d; includeDependencies=&#x201c;myobject.chngABC&#x201d; =&gt; would include myobject.chngABC in the dependency calculation</li>
</ul></div>
<div class="section">
<h3><a name="Tie-break_logic_for_consistent_order"></a>Tie-break logic for consistent order</h3>
<p>After the dependencies are declared, the changes are deployed respecting that order using <a class="externalLink" href="https://en.wikipedia.org/wiki/Topological_sorting">Topological Sort</a>. Apart from those mandated dependency orders, the sort order will break ties based on the following change types:</p>

<ol style="list-style-type: decimal">
  
<li>Sequences</li>
  
<li>Table changes</li>
  
<li>Functions</li>
  
<li>Views</li>
  
<li>Stored Procedures</li>
  
<li>Migrations</li>
  
<li>Static Data</li>
</ol></div>
<div class="section">
<h3><a name="Graph_Representation_of_Schema_Objects"></a>Graph Representation of Schema Objects</h3>
<p>Given that the basis of Obevo is to handle a graph representation of the schema, it would make sense to be able to represent the schema objects in a graph format.</p>
<p>To enable this, use the -sourceGraphExportFile and -sourceGraphExportFormat arguments into the main deploy.sh client. The available formats are DOT (the default), GML, GRAPHML, and MATRIX.</p></div></div>
<div class="section">
<h2><a name="Managing_Static_Data__Code_Tables"></a>Managing Static Data / Code Tables</h2>
<p>Many systems store tables just for static/code data, not necessarily dynamic data.</p>
<p>For these cases, Obevo supports maintaining these as rerunnable files, such that if you wanted to add/modify/delete a row, you can just edit the file content in place, instead of having to specifically code to an incremental update statement.</p>
<p>These would go under the /staticdata folder in your schema (i.e. at the same level as /table, /sp, /view, etc.</p>
<p>Within that folder, you can use 2 methodologies for organizing your data, depending on which use case fits you better. (both can coexist within that folder and be used for different tables in the folder)</p>
<div class="section">
<h3><a name="Methodology_1_File-per-table_the_common_use_case"></a>Methodology 1) File-per-table (the common use case)</h3>
<p>Here, we define a file per code table (i.e. the same paradigm that we use for the other objects in obevo, like tables/sps/views/etc.)</p>
<p>e.g. say we want to maintain static data for 3 tables, VIEW*DEF, VIEW*COLUMN, COLUMNDEF; the directory would look like this:</p>

<div class="source">
<div class="source"><pre class="prettyprint">/myschema/staticdata
/myschema/staticdata/VIEW_DEF.csv
/myschema/staticdata/VIEW_COLUMN.sql
/myschema/staticdata/COLUMN_DEF.csv
</pre></div></div>
<p>In terms of the actual content format of that file (i.e. how to represent the static data), you have two options:</p></div>
<div class="section">
<h3><a name="Content_Option_A_via_simple_deleteinsert_statements"></a>Content Option A) via simple delete/insert statements</h3>
<p>See the example below; hence, every time you change this file, the script will be rerun (delete all, insert all)</p>
<p>This is a simple option and what you&#x2019;d be used to if doing manual deployments; but if you want a nicer form of representation (or just don&#x2019;t want to delete all your rows for a deployment), then try the CSV option&#x2026;</p>

<div class="source">
<div class="source"><pre class="prettyprint">DELETE FROM COLUMN_DEF
GO
INSERT INTO COLUMN_DEF (COLUMN_ID, COLUMN_NAME, ADD_TIME) VALUES (20, 'col1', '2012-01-01 12:12:12')
GO
INSERT INTO COLUMN_DEF (COLUMN_ID, COLUMN_NAME, ADD_TIME) VALUES (21, 'col2', '2013-01-01 11:11:11.65432')
GO
INSERT INTO COLUMN_DEF (COLUMN_ID, COLUMN_NAME, ADD_TIME) VALUES (22, 'col3', null)
GO
INSERT INTO COLUMN_DEF (COLUMN_ID, COLUMN_NAME, ADD_TIME) VALUES (50, 'txncol1', null)
GO
INSERT INTO COLUMN_DEF (COLUMN_ID, COLUMN_NAME, ADD_TIME) VALUES (51, 'txncol2', '2012-01-01 12:12:12')
GO
INSERT INTO COLUMN_DEF (COLUMN_ID, COLUMN_NAME, ADD_TIME) VALUES (52, 'txncol3', '2013-01-01 11:11:11.65432')
GO
</pre></div></div></div>
<div class="section">
<h3><a name="Content_Option_B_via_CSV_the_preferred_method"></a>Content Option B) via CSV (the preferred method)</h3>

<div class="source">
<div class="source"><pre class="prettyprint">COLUMN_ID, COLUMN_NAME, ADD_TIME
20, &quot;col1&quot;, &quot;2012-01-01 12:12:12&quot;
21, &quot;col2&quot;, &quot;2013-01-01 11:11:11.65432&quot;
22, &quot;col3&quot;, null
50, &quot;txncol1&quot;, null
51, &quot;txncol2&quot;, &quot;2012-01-01 12:12:12&quot;
52, &quot;txncol3&quot;, &quot;2013-01-01 11:11:11.65432&quot;
</pre></div></div>
<p>Just define a CSV file (quotes are supported, as is changing the comma delimiter and null token) with the first row as the column names, and you are set</p>
<p>If a change is done on the table, Obevo will only deploy the incremental change (it will compare the full dataset in the db table vs. the file and apply the appropriate insert/update/delete)</p>
<p>Note that there is reverse-engineering available to make this easy to onboard for existing projects (see the [existing-onboarding-guide](Onboarding Guide) for more details).</p>
<div class="section">
<h4><a name="Note:_Primary_Key_requirement"></a>Note: Primary Key requirement</h4>
<p>To manage a table as static data in Obevo, a unique key must be defined, whether physically on the table, or configured in code.</p>
<p>Specifically, either as: - (Preferred) An explicit primary key or unique index if one doesn&#x2019;t exist already (this is a good practice to do anyway) - Or defining a metadata attribute as follows, in case you cannot physically define the constraint</p>

<div class="source">
<div class="source"><pre class="prettyprint">//// METADATA primaryKeys=&quot;field1,field2&quot;
field1,field2,value
a,b,11
c,d,22
</pre></div></div>
<p>Note that the PK or unique index is only considered if all of its columns are defined in the CSV (otherwise, Obevo would not be able to correctly compare results between the CSV and the actual database).</p>

<ul>
  
<li>This use case typically comes up for tables with auto-generated identity columns. In such cases, the identity column should not be defined in the CSV, but you can define a separate unique index or metadata attribute to define the columns that should serve as the key for the CSV load.</li>
</ul>
<p>Note that if you do have a valid physical primary key or unique index on the table, then you are not allowed to define the metadata attribute as an override.</p></div>
<div class="section">
<h4><a name="Note:_updateTimeColumn_feature"></a>Note: updateTimeColumn feature</h4>
<p>You can define certain columns as an &#x201c;updateTimeColumn&#x201d; if you&#x2019;d like its value to be updated to the current timestamp when its row is either inserted or updated, per the example below.</p>

<div class="source">
<div class="source"><pre class="prettyprint">//// METADATA updateTimeColumn=&quot;col1&quot; ...
field1,field2,value
a,b,11
</pre></div></div>
<p>This column would not be specified in your CSV file.</p>
<p>Implementation note: the time value is set in Java and passed to the database via JDBC, and not as a &#x201c;current timestamp&#x201d; keyword in the DB implementation.</p></div></div>
<div class="section">
<h3><a name="Note_on_the_static_data_methodology_with_respect_to_tables_related_by_foreign_key_CSV_mode_is_required"></a>Note on the static data methodology with respect to tables related by foreign key (CSV mode is required)</h3>
<p>If you have tables that depend on each other via foreign key, <i><u>you must use the CSV format</u></i> (which is the preference anyway).</p>
<p>The reason here is that if you have inserts/updates/deletes spanning those related tables, the operations need to be done in the correct foreign-key dependency order.</p>
<p>For example:</p>

<ul>
  
<li>Say that TableA depends on TableB, and TableB depends on TableC. And you want to insert static data for all those tables</li>
  
<li>Then, the inserts must first be done in TableC, then TableB, then TableA</li>
  
<li>However, the deletions must be done in the <i>reverse</i> order (TableA, then TableB, then TableC)</li>
</ul>
<p>Lucky for you, Obevo takes care of this!</p>

<ul>
  
<li>Obevo knows how your tables are related to each other via FK (assuming you&#x2019;ve defined those foreign keys in your table DDLs in the first place), and thus can manage the dependency order accordingly on the CSV side</li>
  
<li>Simply edit the CSV files as you need to, and Obevo takes care of the rest</li>
</ul></div>
<div class="section">
<h3><a name="Methodology_2_File-per-staticDataGroup_i.e._common_static_data_across_a_set_of_tables"></a>Methodology 2) File-per-staticDataGroup (i.e. common static data across a set of tables)</h3>
<p>Some use cases lend themselves towards representing static data not per table, but for a set of tables involving a particular context. For example, a set of tables that together represent metadata for some application, but the metadata definitions make more sense grouped from the user context and not the table context.</p>
<p>In those cases, your files may make sense to represent like this (taking the same content above, but represent it in the staticDataGroup mode)</p>

<div class="source">
<div class="source"><pre class="prettyprint">### position-view.sql ###
delete from view where view_id = 1
delete from column_def where column_id in (20,21,22)
delete from view_columns where view_id = 1

insert into view (1, &quot;position&quot;)

insert into view_columns (1, 20)
insert into view_columns (1, 21)
insert into view_columns (1, 22)

insert into column_def (20, &quot;col1&quot;)
insert into column_def (21, &quot;col2&quot;)
insert into column_def (22, &quot;col3&quot;)
</pre></div></div>

<div class="source">
<div class="source"><pre class="prettyprint">### transaction-view.sql ###
delete from view where view_id = 5
delete from column_def where column_id in (20,21,22)
delete from view_columns where view_id = 5

insert into view (5, &quot;transaction&quot;)

insert into view_columns (5, 50)
insert into view_columns (5, 51)
insert into view_columns (5, 52)

insert into column_def (50, &quot;txncol1&quot;)
insert into column_def (51, &quot;txncol2&quot;)
insert into column_def (52, &quot;txncol3&quot;)
</pre></div></div>
<p>Note that:</p>

<ul>
  
<li>We use delete-insert for this methodology. CSV is not yet supported for this, but will be in the future</li>
  
<li>Each file needs the deletes to come first in the first so that this script can be rerunnable, then followed by the inserts. The deletes/inserts should follow the appropriate FK order (i.e. delete the dependents first, insert the dependencies first)</li>
</ul>
<p>Though the file name is not strictly a &#x201c;db-object&#x201d; view at this point, it is still a rerunnable script and makes more sense from a maintainability perspective, so go right ahead and do it if it makes sense for your use case!</p></div></div>
<div class="section">
<h2><a name="Ad-hoc_data_migrations"></a>Ad-hoc data migrations</h2>
<p>Note from the author to those who read this section for past versions: yes, this text has changed a lot :) - we now support ad-hoc data migrations, as we recognize that some teams are fine to do backwards-incompatible changes whereas others do not. Will explain more below.</p>
<div class="section">
<h3><a name="Explaining_the_use_case"></a>Explaining the use case</h3>
<p>Use this for one-time data migrations on your transactional tables (i.e. not the static data tables).</p>
<p>Note that these kinds of SQLs can easily be executed within the /table files themselves, as ultimately those just execute SQLs. In fact, the format of the /migration files is the same as the format of the /table files.</p>
<p>So when would you define the changes in /migration files vs. /table files?</p>
<p><b><u>Migrations in /table file?</u></b>: Very simple backfills of newly added columns (e.g. the snippet below)</p>

<div class="source">
<div class="source"><pre class="prettyprint">alter table TABLE_A add new column MYCOL
GO
update TABLE_A set MYCOL = 0
GO
</pre></div></div>
<p><b><u>Migrations in /migration file?]</u></b>: some use cases:</p>

<ul>
  
<li>If the migration involved multiple tables; thus, it wouldn&#x2019;t make sense to house this in a table-specific file.</li>
  
<li>A one-time update that you don&#x2019;t want to see continuously executed as part of your schema definition, say for your test schemas or in-memory db schemas or correcting missing GRANT statements.</li>
  
<li>For backwards-incompatible updates, where some new column/table needs to be populated from the old one, and then the old column/table needs to be dropped.</li>
  
<li>See the example below (note the &#x201c;dependencies&#x201d; attribute in the removeOldCol change and migration2 file that <a href="#DB_Object_Deployment_Order">we mentioned above</a>): splitting the migration into a separate section lets us clearly see what the schema should look like in the /table file, while letting the migration be defined elsewhere.</li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">{/table/TABLE_A.sql file}
//// CHANGE name=&quot;init&quot;
CREATE TABLE TABLE_A (COL1 INT, COL2 INT, ...)
GO
//// CHANGE name=&quot;addNewCol2&quot;
ALTER TABLE TABLE_A ADD NEWCOL2 (INT)
GO

//// CHANGE name=&quot;removeOldCol&quot; dependencies=&quot;migration2.step1&quot;
ALTER TABLE TABLE_A DROP COL2
GO

{/migration/migration2.sql file}
//// CHANGE name=&quot;step1&quot; dependencies=&quot;TABLE_A.addNewCol2&quot;
UPDATE TABLE_A SET NEWCOL2 = COL2 + 1
GO
</pre></div></div></div>
<div class="section">
<h3><a name="Usage_Details"></a>Usage Details</h3>
<p>1) Define the files in the /migration folder</p>
<p>2) File content is the same as for tables, i.e.</p>

<ul>
  
<li>Use //// CHANGE entries as needed.</li>
  
<li>//// METADATA section and attributes like includeEnvs/excludeEnvs still apply.</li>
</ul>
<p>Differences from /table representation:</p>
<p>A) The file name need not correspond to a db-object name. You are free to name this as you please.</p>
<p>B) You <b><i>are allowed to delete /migration CHANGE entriesafter being deployed</i></b> . This is because we don&#x2019;t want/need migrations lying around in the code, as they are one-time activities. Deleting the entries will <i>UNMANAGE</i> them from Obevo, akin to the <i>UNMANAGE</i>/delete operation with static data tables. i.e. if the migration file is deleted, the entry is removed from the audit table, and Obevo leaves the table untouched otherwise.</p></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2017&#x2013;2019
<a href="http://www.goldmansachs.com/">Goldman Sachs</a>.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
