<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.7.4 at 2019-06-14 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20190614" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Obevo &#x2013; Rollback</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarEnabled">
                      <a href="https://github.com/goldmansachs/obevo">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 10000;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"
        alt="Fork me on GitHub">
    </a>
      <div id="topbar" class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
        <a data-target=".nav-collapse" data-toggle="collapse" class="btn btn-navbar">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </a>
            <ul class="nav">
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="index.html" title="Intro">Intro</a></li>
            <li><a href="overview.html" title="Overview">Overview</a></li>
            <li><a href="setup.html" title="Setup">Setup</a></li>
            <li><a href="support.html" title="Help and Support">Help and Support</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Technical Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="db-project-structure.html" title="DB Project Structure">DB Project Structure</a></li>
            <li><a href="environment-management.html" title="Environment Management">Environment Management</a></li>
            <li><a href="permission-management.html" title="Permission Management">Permission Management</a></li>
            <li><a href="error-handling.html" title="Error-Handling">Error-Handling</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">API Documentation <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="command-line-api.html" title="Command-line API">Command-line API</a></li>
            <li><a href="java-api.html" title="Java API">Java API</a></li>
            <li><a href="maven-api.html" title="Maven plugin API">Maven plugin API</a></li>
            <li><a href="gradle-api.html" title="Gradle API">Gradle API</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Advanced Topics <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="db-project-best-practices.html" title="DB Project Best Practices">DB Project Best Practices</a></li>
            <li><a href="rollback.html" title="Rollback">Rollback</a></li>
            <li><a href="multiple-schema-management.html" title="Multiple Schema Management">Multiple Schema Management</a></li>
            <li><a href="schema-and-config-packaging.html" title="Separate Schema and Config Packaging">Separate Schema and Config Packaging</a></li>
            <li><a href="in-memory-db-testing.html" title="In-memory DB Testing">In-memory DB Testing</a></li>
            <li><a href="parallel-deploy-execution.html" title="Parallel Deploy Execution">Parallel Deploy Execution</a></li>
            <li><a href="orm-integration.html" title="ORM Integration">ORM Integration</a></li>
            <li><a href="baseline-validation.html" title="Baseline DDL Validation">Baseline DDL Validation</a></li>
            <li><a href="phased-deployments.html" title="Phased Deployments">Phased Deployments</a></li>
            <li><a href="incremental-change-code-cleanup.html" title="Incremental Change Code Cleanup">Incremental Change Code Cleanup</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Platform-Specific Details <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="platform-listing.html" title="Platform Listing">Platform Listing</a></li>
            <li><a href="db2-notes.html" title="DB2">DB2</a></li>
            <li><a href="general-db-notes.html" title="HSQLDB">HSQLDB</a></li>
            <li><a href="general-db-notes.html" title="H2">H2</a></li>
            <li><a href="mongodb-notes.html" title="MongoDB">MongoDB</a></li>
            <li><a href="oracle-notes.html" title="Oracle">Oracle</a></li>
            <li><a href="postgresql-notes.html" title="PostgreSQL">PostgreSQL</a></li>
            <li><a href="redshift-notes.html" title="Redshift">Redshift</a></li>
            <li><a href="sybase-ase-notes.html" title="SQL Server">SQL Server</a></li>
            <li><a href="sybase-ase-notes.html" title="Sybase ASE">Sybase ASE</a></li>
            <li><a href="general-db-notes.html" title="Sybase IQ">Sybase IQ</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Onboarding Guide <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li><a href="onboarding-guide.html" title="Which onboarding to choose?">Which onboarding to choose?</a></li>
            <li><a href="new-onboarding-guide.html" title="New Systems">New Systems</a></li>
            <li><a href="existing-onboarding-guide.html" title="Existing Systems">Existing Systems</a></li>
            <li><a href="existing-diverging-onboarding-guide.html" title="Existing Systems with Diverging Shards">Existing Systems with Diverging Shards</a></li>
            <li><a href="legacy-onboarding-guide.html" title="Legacy Onboarding - Legacy Systems">Legacy Onboarding - Legacy Systems</a></li>
            <li><a href="db-merge-tool.html" title="DB Merge Tool">DB Merge Tool</a></li>
        </ul>
      </li>
        <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developer Information <b class="caret"></b></a>
        <ul class="dropdown-menu">
            <li class="dropdown-submenu">
<a href="developer-guide.html" title="Developer Guide">Developer Guide</a>
              <ul class="dropdown-menu">
                  <li><a href="dev-setup-docker.html" title="Docker-based Test DB Setup">Docker-based Test DB Setup</a></li>
                  <li><a href="dev-setup-amazon.html" title="Amazon RDS DB Setup">Amazon RDS DB Setup</a></li>
                  <li><a href="dev-setup-sybase-ase.html" title="Sybase ASE Test DB Setup">Sybase ASE Test DB Setup</a></li>
              </ul>
            </li>
            <li><a href="design-walkthrough.html" title="Design Walkthrough">Design Walkthrough</a></li>
        </ul>
      </li>
              </ul>
            </div>
        </div>
      </div>
    </div>
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="./" id="bannerLeft"><h2>Obevo</h2>
</a></div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li class=""><a href="./" title="Obevo">Obevo</a><span class="divider">/</span></li>
    <li class="active ">Rollback</li>
        <li id="publishDate" class="pull-right"><span class="divider">|</span> Last Published: 2019-06-14</li>
          <li id="projectVersion" class="pull-right">Version: master-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Getting Started</li>
    <li><a href="index.html" title="Intro"><span class="none"></span>Intro</a>  </li>
    <li><a href="overview.html" title="Overview"><span class="none"></span>Overview</a>  </li>
    <li><a href="setup.html" title="Setup"><span class="none"></span>Setup</a>  </li>
    <li><a href="support.html" title="Help and Support"><span class="none"></span>Help and Support</a>  </li>
          <li class="nav-header">Technical Documentation</li>
    <li><a href="db-project-structure.html" title="DB Project Structure"><span class="none"></span>DB Project Structure</a>  </li>
    <li><a href="environment-management.html" title="Environment Management"><span class="none"></span>Environment Management</a>  </li>
    <li><a href="permission-management.html" title="Permission Management"><span class="none"></span>Permission Management</a>  </li>
    <li><a href="error-handling.html" title="Error-Handling"><span class="none"></span>Error-Handling</a>  </li>
          <li class="nav-header">API Documentation</li>
    <li><a href="command-line-api.html" title="Command-line API"><span class="none"></span>Command-line API</a>  </li>
    <li><a href="java-api.html" title="Java API"><span class="none"></span>Java API</a>  </li>
    <li><a href="maven-api.html" title="Maven plugin API"><span class="none"></span>Maven plugin API</a>  </li>
    <li><a href="gradle-api.html" title="Gradle API"><span class="none"></span>Gradle API</a>  </li>
          <li class="nav-header">Advanced Topics</li>
    <li><a href="db-project-best-practices.html" title="DB Project Best Practices"><span class="none"></span>DB Project Best Practices</a>  </li>
    <li class="active"><a href="#"><span class="none"></span>Rollback</a>
  </li>
    <li><a href="multiple-schema-management.html" title="Multiple Schema Management"><span class="none"></span>Multiple Schema Management</a>  </li>
    <li><a href="schema-and-config-packaging.html" title="Separate Schema and Config Packaging"><span class="none"></span>Separate Schema and Config Packaging</a>  </li>
    <li><a href="in-memory-db-testing.html" title="In-memory DB Testing"><span class="none"></span>In-memory DB Testing</a>  </li>
    <li><a href="parallel-deploy-execution.html" title="Parallel Deploy Execution"><span class="none"></span>Parallel Deploy Execution</a>  </li>
    <li><a href="orm-integration.html" title="ORM Integration"><span class="none"></span>ORM Integration</a>  </li>
    <li><a href="baseline-validation.html" title="Baseline DDL Validation"><span class="none"></span>Baseline DDL Validation</a>  </li>
    <li><a href="phased-deployments.html" title="Phased Deployments"><span class="none"></span>Phased Deployments</a>  </li>
    <li><a href="incremental-change-code-cleanup.html" title="Incremental Change Code Cleanup"><span class="none"></span>Incremental Change Code Cleanup</a>  </li>
          <li class="nav-header">Platform-Specific Details</li>
    <li><a href="platform-listing.html" title="Platform Listing"><span class="none"></span>Platform Listing</a>  </li>
    <li><a href="db2-notes.html" title="DB2"><span class="none"></span>DB2</a>  </li>
    <li><a href="general-db-notes.html" title="HSQLDB"><span class="none"></span>HSQLDB</a>  </li>
    <li><a href="general-db-notes.html" title="H2"><span class="none"></span>H2</a>  </li>
    <li><a href="mongodb-notes.html" title="MongoDB"><span class="none"></span>MongoDB</a>  </li>
    <li><a href="oracle-notes.html" title="Oracle"><span class="none"></span>Oracle</a>  </li>
    <li><a href="postgresql-notes.html" title="PostgreSQL"><span class="none"></span>PostgreSQL</a>  </li>
    <li><a href="redshift-notes.html" title="Redshift"><span class="none"></span>Redshift</a>  </li>
    <li><a href="sybase-ase-notes.html" title="SQL Server"><span class="none"></span>SQL Server</a>  </li>
    <li><a href="sybase-ase-notes.html" title="Sybase ASE"><span class="none"></span>Sybase ASE</a>  </li>
    <li><a href="general-db-notes.html" title="Sybase IQ"><span class="none"></span>Sybase IQ</a>  </li>
          <li class="nav-header">Onboarding Guide</li>
    <li><a href="onboarding-guide.html" title="Which onboarding to choose?"><span class="none"></span>Which onboarding to choose?</a>  </li>
    <li><a href="new-onboarding-guide.html" title="New Systems"><span class="none"></span>New Systems</a>  </li>
    <li><a href="existing-onboarding-guide.html" title="Existing Systems"><span class="none"></span>Existing Systems</a>  </li>
    <li><a href="existing-diverging-onboarding-guide.html" title="Existing Systems with Diverging Shards"><span class="none"></span>Existing Systems with Diverging Shards</a>  </li>
    <li><a href="legacy-onboarding-guide.html" title="Legacy Onboarding - Legacy Systems"><span class="none"></span>Legacy Onboarding - Legacy Systems</a>  </li>
    <li><a href="db-merge-tool.html" title="DB Merge Tool"><span class="none"></span>DB Merge Tool</a>  </li>
          <li class="nav-header">Developer Information</li>
    <li><a href="developer-guide.html" title="Developer Guide"><span class="icon-chevron-down"></span>Developer Guide</a>
      <ul class="nav nav-list">
    <li><a href="dev-setup-docker.html" title="Docker-based Test DB Setup"><span class="none"></span>Docker-based Test DB Setup</a>  </li>
    <li><a href="dev-setup-amazon.html" title="Amazon RDS DB Setup"><span class="none"></span>Amazon RDS DB Setup</a>  </li>
    <li><a href="dev-setup-sybase-ase.html" title="Sybase ASE Test DB Setup"><span class="none"></span>Sybase ASE Test DB Setup</a>  </li>
      </ul>
  </li>
    <li><a href="design-walkthrough.html" title="Design Walkthrough"><span class="none"></span>Design Walkthrough</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<!--

    Copyright 2017 Goldman Sachs.
    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.

--><h1>Rollback</h1>
<p>What should you consider when rolling back? Read on for the various options.</p>
<hr />

<ul>
<li><a href="#Roll-back__roll-forward_considerations_during_or_after_DB_deployment">Roll-back / roll-forward considerations during or after DB deployment</a>
<ul>
<li><a href="#Paradigm_1:_Avoiding_rollbacks_using_backwards-compatible_changes">Paradigm 1: Avoiding rollbacks using backwards-compatible changes</a></li>
<li><a href="#Paradigm_2:_Rolling_forward_i.e._executing_new_changes_to_rollback">Paradigm 2: Rolling forward, i.e. executing new changes to rollback</a></li>
<li><a href="#Paradigm_3:_Backing_up_the_whole_DB_e.g._dbdump_and_restore">Paradigm 3: Backing up the whole DB (e.g. dbdump and restore)</a></li>
<li><a href="#Paradigm_4:_Traditional_rollback_i.e._preparing_rollback_scripts_alongside_your_release">Paradigm 4: Traditional rollback, i.e. preparing rollback scripts alongside your release</a></li>
<li><a href="#Anti-Pattern_Paradigm:_Backing_up_individual_tables_before_deployment">Anti-Pattern Paradigm: Backing up individual tables before deployment</a></li></ul></li>
<li><a href="#Roll-back__roll-forward_considerations_for_non-prod_deployments">Roll-back / roll-forward considerations for non-prod deployments</a></li></ul>
<div class="section">
<h2><a name="Roll-back__roll-forward_considerations_during_or_after_DB_deployment"></a>Roll-back / roll-forward considerations during or after DB deployment</h2>
<p>This section describes actions you would take to handle issues that prevent you from otherwise proceeding (or planning ahead for such cases). The main use cases:</p>

<ol style="list-style-type: decimal">
  
<li>UC1: Issues during a deployment execution (i.e. the previous section)</li>
  
<li>UC2: Issues during application execution after a successful DB deployment, or for planning ahead for such cases (e.g. rollback preparation)
  
<ul>
    
<li>i.e. in case the DB deployment succeeds, and the application rollout does not, you have two choices with your application: roll-forward or roll-back. Roll-forward should imply that your database changes can remain. What about rolling the application back - what then with your DB code?</li>
  </ul></li>
</ol>
<p>The following are various paradigms to follow to handle or plan for these situations. We list these out in priority order:</p>

<ol style="list-style-type: decimal">
  
<li>(Most favored) Avoiding rollbacks using backwards-compatible changes</li>
  
<li>Rolling forward, i.e. executing new changes to rollback</li>
  
<li>Backing up the whole DB (e.g. dbdump and restore)</li>
  
<li>(Least favored) Traditional rollback, i.e. preparing rollback scripts alongside your release</li>
</ol>
<p>You may ultimately need to consider all options; e.g. you may always write backwards-compatible changes, but you may still need to roll forward in some cases.</p>
<p>More details on each section:</p>
<div class="section">
<h3><a name="Paradigm_1:_Avoiding_rollbacks_using_backwards-compatible_changes"></a>Paradigm 1: Avoiding rollbacks using backwards-compatible changes</h3>
<p>(Only applicable for UC2)</p>
<p>If it were easy to put your database back into its previous state, then great. Most often, it is not the case, as tables are stateful objects. For example, adding and then removing table columns would mean physically changing all the rows in the database, which can be an expensive operation. Not to mention that such a rollback operation should also be tested.</p>
<p>What is an easier way to roll back your DB changes then? How about&#x2026;not rolling them back at all?</p>
<p>Making your DB schema changes backwards-compatible to your code would help in this regard. The DB migration can only be done once and not worried about again, as this is a relatively more expensive operation than app binary updates.</p>
<p>Some teams have taken it as far as <b><u>releasing DB code changes far in advance of application code changes</u></b> as to prove backwards compatibility.</p>
<p>Some general rules on what changes are/aren&#x2019;t backwards-compatible:</p>

<ul>
  
<li>Backwards-compatible: adding a nullable column</li>
  
<li>NOT Backwards-compatible: adding a non-nullable column</li>
  
<li>NOT Backwards-compatible: removing a column in use in production today</li>
  
<li>Backwards-compatible: removing a column that is not used in production code and has no risk of being used due to rollback</li>
  
<li>Risk of NOT Backwards-compatible: stored procedure or view changes; treat this as you would treat code in terms of attempting to preserve backwards-compatibility</li>
</ul>
<p>More notes here on <a class="externalLink" href="http://martinfowler.com/articles/evodb.html">Martin Fowler&#x2019;s page</a> (search for references to &#x201c;destructive chagnes&#x201d;)</p>
<p>However, you may not be able to escape such non-backwards-compatible changes; or you may choose not choose for the overhead of backwards-compatible changes. Then choose from the next possible options.</p></div>
<div class="section">
<h3><a name="Paradigm_2:_Rolling_forward_i.e._executing_new_changes_to_rollback"></a>Paradigm 2: Rolling forward, i.e. executing new changes to rollback</h3>
<p>Instead of preparing to rollback, you may instead choose to release a new patch version to fix the issue with your release. The patch can be either in your application code or in your database code.</p>
<p>A risk here is that you do not have your changes pre-planned, and so if an issue comes up, you would need to come up w/ a solution on the fly. However, depending on your application characteristics (well-tested, nimble for making and deploying changes, able to cope with the bug for long enough), this can be suitable for you as this saves the overhead of planning out backwards-compatible changes or rollback scripts.</p>
<p>To roll forward, treat this change much as you would treat a patch release, e.g.</p>

<ul>
  
<li>Check out your prod tag/branch that has these DB changes</li>
  
<li>Add a new //// CHANGE to the file to undo the impact of the change that you added</li>
  
<li>Commit your code</li>
  
<li>Execute the deploy&#x2026;</li>
</ul>
<p>&#x2026; For executing the deploy, you have options:</p>

<ol style="list-style-type: decimal">
  
<li>You can always go through the standard deployment process to release this change (i.e. much as you would for an application code change). This is the preferred approach</li>
  
<li>Or you may feel you can&#x2019;t wait for the build to go through. In that case, you can just call Obevo locally against your checked-out code. (It is just Java after all; it can execute anywhere. But ensure that your code is committed)
  
<ul>
    
<li>However, from an SDLC perspective, this is not recommended. Please try to abide by your team&#x2019;s/firm&#x2019;s build and release practices.</li>
  </ul></li>
</ol></div>
<div class="section">
<h3><a name="Paradigm_3:_Backing_up_the_whole_DB_e.g._dbdump_and_restore"></a>Paradigm 3: Backing up the whole DB (e.g. dbdump and restore)</h3>
<p>Ultimately, the purest form of rollback would be to take a raw copy of the DB before doing the deployment, and then switching back to it if the code also needs to get rolled back.</p>
<p>Some DBMSs (e.g. Sybase ASE) do provide such tooling for this (e.g. dbdump and restore). Thus, you can resort to this mode of rollback if you choose (likely, your DBAs should be taking backups of your DB anyway). As the Obevo audit table is also physically on your target DB, the state of the audit table will also get rolled back to where it should be.</p>
<p>The main negative with this approach is if your DB is huge, then this process will take a while to run and requires a lot of disk storage in your infrastructure. Hence, most teams will not go with this for practical reasons, but certainly if you have the resources and time for it, this is an acceptable option.</p></div>
<div class="section">
<h3><a name="Paradigm_4:_Traditional_rollback_i.e._preparing_rollback_scripts_alongside_your_release"></a>Paradigm 4: Traditional rollback, i.e. preparing rollback scripts alongside your release</h3>
<p>Obevo supports rollback by simply allowing developers to point to their old DB package and re-deploy w/ the -rollback flag attached</p>
<p>For example:</p>

<div class="source">
<div class="source"><pre class="prettyprint"># do the deployment of version 1
$OBEVO_HOME/bin/deploy.bat DEPLOY -env prod -sourcePath /home/myuser/mypackage/1.0.0/db

# do the deployment of version 2 (which contains rollback scripts if needed)
$OBEVO_HOME/bin/deploy.bat DEPLOY -env prod -sourcePath /home/myuser/mypackage/2.0.0/db

# let's say that goes bad; we'll rollback to version 1 by deploying it w/ the -rollback tag
$OBEVO_HOME/bin/deploy.bat DEPLOY -env prod -sourcePath /home/myuser/mypackage/1.0.0/db -rollback
</pre></div></div>
<p>In the example above, the changes in version 2 need to include the rollback scripts.</p>
<p>In terms of what roll providing the scripts:</p>

<ul>
  
<li>For stateless objects (i.e. everything except &#x201c;table&#x201d; changes): nothing extra is needed. Obevo simply detects the objects in the old location and applies those (doing the appropriate drops and adds as necessary)</li>
  
<li>For tables:
  
<ul>
    
<li>If you don&#x2019;t want to add a rollback script for a particular //// CHANGE, nothing extra is needed. Obevo will simply let the change remain.</li>
    
<li>If you do want a rollback script for a particular //// CHANGE, add a // ROLLBACK subsection to the change in question. See the example below, note the &#x201c;chng-from-2.0.0&#x201d; CHANGE</li>
    
<li>Note: the ROLLBACK section should not be blank, as it will be ignored and not considered during rollback execution. This will be corrected in a future release.</li>
  </ul></li>
</ul>

<div class="source">
<div class="source"><pre class="prettyprint">//// CHANGE name=chng-from-1.0.0
CREATE TABLE TABLE_A (
    A_ID INT NOT NULL,
    B_ID INT NOT NULL,
    STRING_FIELD VARCHAR(30) NULL,
    TIMESTAMP_FIELD TIMESTAMP NULL,
    PRIMARY KEY (A_ID)
)
GO
//// CHANGE name=chng-from-2.0.0
ALTER TABLE TABLE_A ADD COLUMN C_ID INT NULL
GO
// ROLLBACK
ALTER TABLE TABLE_A DROP COLUMN C_ID
GO
</pre></div></div>
<p>In case you are interested in the technical details behind this: {panel}First, let&#x2019;s review how regular deployments are done and changes detect (see <a href="design-walkthrough.html">Design Walkthrough</a> doc)</p>

<ul>
  
<li>For stateless objects (sp, view, &#x2026;): when we detect a change between the source code and what was deployed in the db (whether a change in the file, a creation of a new file, or a deletion/drop of the file), we simply detect it and apply the change.</li>
  
<li>For stateful objects (tables): table changes are detected as new //// CHANGE entries in the file. And we are not allowed to drop or modify any previously-deployed changes</li>
</ul>
<p>Now for rollback:</p>

<ul>
  
<li>For stateless objects, we have no problem, as going from v2.0.0 to v1.0.0. is just created as another deployment change, and so we&#x2019;d deploy whatever changes we&#x2019;d get when going from 2.0.0 to 1.0.0</li>
  
<li>For tables, we will typically get a case where the tool detects that we&#x2019;ve improperly removed a change from the file that has been deployed already. The -rollback flag handles this by:
  
<ul>
    
<li>Will not fail the deployment if some exception like this is detected</li>
    
<li>For each deployed change, we have the option of specifying a // ROLLBACK command (see below). This will only get activated if we execute -rollback and we have a case where a change deployed as part of 2.0.0 is no longer there in 1.0.0</li>
    
<li>Fyi, this -ROLLBACK script is stored in the audit table. This is because it is v2.0.0&#x2019;s changes that we are rolling back, and if we rollback by pointing to the old version, then we&#x2019;d have no place to get the rollback script from. Hence, we store it in the db{panel}</li>
  </ul></li>
</ul>
<p>Note that if you execute this rollback command, it will still ultimately remain in your source code to be deployed in subsequent releases and in the UAT environments that you deployed to. If you want to remove this change entirely (i.e. not let it come back in the next release), see the section below for &#x201c;(Special Case) Undoing a table/incremental change permanently in non-prod or after rollback&#x201d;</p></div>
<div class="section">
<h3><a name="Anti-Pattern_Paradigm:_Backing_up_individual_tables_before_deployment"></a>Anti-Pattern Paradigm: Backing up individual tables before deployment</h3>
<p>This involves creating a backup of the table during your deployment (e.g. MY_TABLE_BAK20141017), copying the data over, and proceeding w/ the deployment.</p>
<p>Pros:</p>

<ul>
  
<li>Preserves your data, particularly for complex migrations that you do Cons:</li>
  
<li>Takes time and space to copy the data over (not as efficient in runtime as a db copy, as ultimately this needs to be expressed a SQL)</li>
  
<li>Requires some coding to perform, incl. the sqls to copy the data over and to rerun stats after rolling back (if we do end up rolling back)</li>
  
<li>Need to remember to clean up the tables after the fact</li>
</ul>
<p>While certainly we can add tooling around this to support this use case, most teams can get by using the others listed earlier. Hence, we haven&#x2019;t built anything to support this paradigm as of yet</p></div></div>
<div class="section">
<h2><a name="Roll-back__roll-forward_considerations_for_non-prod_deployments"></a>Roll-back / roll-forward considerations for non-prod deployments</h2>
<p>The above scenarios are what you should do if you are rolling back a change in production.</p>
<p>However, in non-prod (e.g. qa/uat), you still have cases where you want to undo a change you had applied during your current version. For undoing table changes, this would mean adding another //// CHANGE entry (assuming you can&#x2019;t just wipe away and clean your db)</p>
<p>But if you are in qa/uat, you may have a lot of these changes building up if you have a lot of corrections. What if you want to be able to undo the change in uat and be able to delete the change entry in your file too? (As discussed a few times earlier, you cannot simply delete a //// CHANGE entry as the tool catches that as a validation error)</p>
<p>To do that, you can add the ROLLBACK-IF-ALREADY-DEPLOYED subsection to your change, e.g.</p>

<div class="source">
<div class="source"><pre class="prettyprint">    //// CHANGE name=chng-from-1.0.0
    CREATE TABLE TABLE_A (
        A_ID INT NOT NULL,
        B_ID INT NOT NULL,
        STRING_FIELD VARCHAR(30) NULL,
        TIMESTAMP_FIELD TIMESTAMP NULL,
        PRIMARY KEY (A_ID)
    )
    GO
    //// CHANGE name=uat-change
    ALTER TABLE TABLE_A ADD COLUMN C_ID INT NULL
    GO
    // ROLLBACK-IF-ALREADY-DEPLOYED
    ALTER TABLE TABLE_A DROP COLUMN C_ID
    GO
</pre></div></div>
<p>The way this will work:</p>

<ul>
  
<li>If the tool sees that &#x201c;uat-change&#x201d; had &#x201c;NOT&#x201d; been deployed and it sees the presence of a ROLLBACK-IF-ALREADY-DEPLOYED section, then it will simply ignore the change</li>
  
<li>If the tool sees that &#x201c;uat-change&#x201d; had already been deployed and it sees the presence of a ROLLBACK-IF-ALREADY-DEPLOYED section, then it will execute the rollback and remove the change name from the deployment audit table. Thus, once you&#x2019;ve wiped this out from all environments, you can delete this section from your file</li>
</ul></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2017&#x2013;2019
<a href="http://www.goldmansachs.com/">Goldman Sachs</a>.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
